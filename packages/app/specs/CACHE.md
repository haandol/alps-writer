## ✅ Claude 3.7 프롬프트 캐시를 위한 캐시포인트 시스템

- 프롬프트 캐시를 위해 캐시포인트를 메시지에 추가해야 한다.
- LLM 은 매 메시지 전송 후 최근 히스토리에 사용자 메시지와 AI 메시지를 추가한다.
- 매 히스토리에 메시지를 추가한 이 후, 현재 최근 히스토리에 대해 캐시포인트를 생성할 수 있는지 확인한다.
- 캐시포인트 생성할 조건이 되면 캐시포인트를 생성하고, cl.user_session 에 모든 캐시포인트의 인덱스를 저장한다.
- 다음 LLM 요청 시, 최근 히스토리에 저장된 캐시포인트를 복구하고 메시지를 빌드한다.
- 빌드된 메시지로 LLM 에 메시지를 전송한다.

### 🔧 시스템 구성 요소
- **LLM 모델**: Claude 3.7 (스트리밍 응답 지원)
- **실제 캐시 저장 위치**: cl.user_session 에 저장된 캐시포인트 인덱스 정보를 리스트로 저장한다.

---

### ✅ 프롬프트 캐시의 캐시포인트 정보

| 항목 | 내용 |
|------|------|
| 캐시포인트 개수 | 최대 **4개** (초과 시 FIFO 방식으로 가장 오래된 것 제거) |
| 캐시포인트 위치 | 시스템 프롬프트, 챕터 5 완료, 챕터 6 완료, 마지막 챕터 완료 |
| 캐시 생성 조건 | 해당 시점의 LLM 응답이 **약 2000 토큰 이상**일 경우에만 생성 |
| 캐시 유지 방식 | 세션에 저장된 캐시를 이후 메시지 빌드 시 프롬프트 앞단에 삽입하여 컨텍스트 유지 |

### 캐시포인트 생성 조건

- 캐시포인트가 없으면 토큰 수 2000 이상일 경우 캐시포인트를 생성한다.
- 캐시포인트가 있으면, 가장 최근에 저장된 캐시포인트의 히스토리 메시지 인덱스로 부터 현재 히스토리 메시지 인덱스까지의 토큰 수가 2000 이상일 경우 새로운 캐시포인트를 생성한다.
- 최대 캐시포인트 숫자에 도달하면 가장 작은 인덱스의 캐시포인트를 제거해주고, 새로운 캐시포인트를 생성한다.
- 캐시포인트를 생성하고 나면, cl.user_session 에 모든 캐시포인트의 인덱스를 저장한다.

### ✅ Chainlit 에서 대화 재개 시 프롬프트 캐시 복구 방법

- Chainlit 은 on_chat_resume hook 에서 대화를 재개하기 전 기존 정보를 복구 하는 역할을 한다.
- 대화를 재개하는 경우, 기존에 저장된 정보를 사용하지 않는다.
- 히스토리의 마지막에 캐시포인트를 추가해준다. (복구된 히스토리의 총 토큰 수가 2000 이상일 경우)

### ✅ 처리 흐름 요약

1. LLM 메시지를 전송하기 전, 유저 세션의 캐시포인트 인덱스 정보를 확인한다.
2. 캐시포인트 인덱스 정보가 있으면 히스토리에 캐시포인트를 추가한다.
3. LLM 은 히스토리를 포함한 메시지 리스트를 이용하여 스트리밍으로 메시지를 전송한다.
4. 스트리밍 응답 후 히스토리에 사용자 메시지와 AI 메시지를 추가한다.
5. 현재 히스토리에 대해 캐시포인트 인덱스 생성 조건인지 확인한다.
6. 캐시포인트 인덱스 생성 조건인 경우 캐시포인트를 생성한다:
   - 현재 응답 토큰 수 ≥ 2000 → 캐시 생성
   - 세션에 캐시 저장 (최대 4개 유지)