---
description: Global ALPS Writer Implementation Guideline
globs: **/*
alwaysApply: true
---
<rules>
- Before implementing any feature, please read first [SPEC.md](mdc:SPEC.md) file carefully.
- When writing LLM code, please read the [llm.mdc](mdc:.cursor/rules/llm.mdc) rules carefully.
- When writing Chainlit code, pease read the [chainlit.mdc](mdc:.cursor/rules/chainlit.mdc)chainlit.md rules carefully.
</rules>

<prerequisites>
- Use Python 3.13
</prerequisites>

<dependency-management>
- Use `uv` tool and `pyproject.toml` to manage dependencies and Python environment
- Use the latest version of each library without specifying a version, unless the user requests a specific one
- As this is a standalone application, no build-system configuration is required in pyproject.toml
</dependency-management>

<code-style-and-architecture>
  <core-principles>
  - Write clean code with clear intent while following PEP8 style guidelines
  - Minimize code duplication through DRY principles and maintain modular/separated structure
  - Utilize type hints extensively to enhance code stability and readability
  </core-principles>

  <architecture-design>
  - Organize code structure by roles: services (src/services), handlers (src/handlers), utilities (src/utils), constants (src/constant)
  - Manage user interactions through Chainlit's async message processing (Async/Await)
  - Securely handle sensitive information (e.g., AWS, Tavily API Keys) via environment variables (.env) loaded with dotenv module
  - Ensure stable operation through Python's logging module and appropriate exception handling (e.g., ClientError)
  </architecture-design>
</code-style-and-architecture>

<user-interface-and-user-experience>
- Structure document creation flow: "New Document" button, chapter-wise Q&A, confirmation messages, file saving
- Store user inputs in internal data structures allowing modifications and rations when needed
</user-interface-and-user-experience>

<integration-web-search-feature>
- Request chapter-specific questions from LLM based on ALPS template and context (F6)
- Process web search commands (`/search [query]`) through command parsing, Tavily API calls, and result formatting
- Include appropriate exception handling and user guidance messages for each feature call
</integration-web-search-feature>

<error-handling>
- Implement comprehensive error handling for all operations
- Log errors appropriately using Python's logging module
- Provide user-friendly error messages through Chainlit interface
- Handle speciftions:
  ```python
  try:
      # Operation code
  except ClientError as e:
      logging.error(f"AWS operation error: {str(e)}")
      await cl.Message(content="Operation failed. Please try again.").send()
  except Exception as e:
      logging.error(f"Unexpected error: {str(e)}")
      await cl.Message(content="An unexpected error occurred.").send()
  ```
</error-handling>

<file-structure>
- Recommended file structure of the project:
  ```
  src/
    ├── services/       # Core business logic
    ├── handlers/       # Request handlers
    ├── utils/          # Utility functions
    ├── prompts/        # LLM prompt templates
    └── constant.py     # Global constants
  env/                  # Env files
  tests/                # Test files
  .env                  # Current Environment variables
  ```
</file-structure>

<conventions>
  <naming-conventions>
  - Classes: PascalCase (e.g., `FileLoadHandler`)
  - Functions/Methods: snake_case (e.g., `handle_save_document`)
  - Variables: snake_case (e.g., `user_message`)
  - Constants: UPPER_SNAKE_CASE (e.g., `MAX_RETRIES`)
  - Files: snake_case (e.g., `file_handler.py`)
  </naming-conventions>

  <documentation-conventions>
  - Include docstrings for all classes and functions using Google style:
    ```python
    def function_name(param1: str, param2: int) -> bool:
        """
        Brief description of function.

        Args:
            param1 (str): Description of param1
            param2 (int): Description of param2

        Returns:
            bool: Description of return value

        Raises:
            ValueError: Description of when this error occurs
        """
    ```
  </documentation-conventions>
</conventions>

<additional-considerations>
- Process sensitive information server-side and expose minimal information to clients
- Follow latest security best practices for security-related features with regular security audits
- Strengthen team collaboration and maintenance culture through commit messages, code reviews, and documentation
</additional-considerations>
